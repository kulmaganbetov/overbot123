import { NextResponse } from "next/server"
import { openai } from "@/lib/openai"

export async function POST(req: Request) {
  try {
    const { question } = await req.json()


    const categories = [
  "—Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã", "–Ω–æ—É—Ç–±—É–∫–∏", "–≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã", "–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã",
  "–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å", "–º–æ–Ω–∏—Ç–æ—Ä—ã", "–ø—Ä–∏–Ω—Ç–µ—Ä—ã",
  "–∫–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã", "–∫–∞—Ä—Ç—ã –ø–∞–º—è—Ç–∏", "–±–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è", "–º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–µ –ø–ª–∞—Ç—ã", "–∫–æ—Ä–ø—É—Å–∞", "–≤–µ–±-–∫–∞–º–µ—Ä—ã", "—á–µ—Ä–Ω–∏–ª—ã"
  // –¥–æ–±–∞–≤—å —Å—é–¥–∞ –∫–ª—é—á–µ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ dealer.json
]

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: `
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π (intent parser) –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ Over-Shop.kz.
–í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ:
${categories.join(", ")}.

–û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä, —Å–æ–±—Ä–∞—Ç—å –ü–ö, –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —É—Ç–æ—á–Ω–∏—Ç—å –≤—ã–±–æ—Ä –∏ —Ç.–¥.)
–∏ –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON.

üì¶ –§–æ—Ä–º–∞—Ç JSON:
{
  "intent": "search_product" | "build_pc" | "add_component" | "refine_selection" | "greeting" | "unknown" | "order_build",
  "original_query": "—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
  "normalized_query": "–æ—á–∏—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
  "component_name": "–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∏–Ω–∞—á–µ null",
  "budget": 500000 | null,
  "filters": {
    "brand": ["ASUS", "Gigabyte"],
    "category": ["–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä", "–≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞"],
    "keywords": ["intel", "ryzen", "cpu", "gpu", "rtx", "4060"],
    "min_price": null,
    "max_price": null
  },
  "components": {
    "cpu": "Intel Core i5" | null,
    "motherboard": "ASUS PRIME B550M" | null,
    "gpu": "RTX 4060 Ti" | null,
    "ram": "32GB DDR5" | null,
    "storage": "SSD 1TB" | null,
    "case": "Deepcool" | null,
    "psu": "650W" | null
  },
  "context_related": true | false,
  "language": "ru" | "kk" | "en",
  "confidence": 0.0-1.0,
  "needs_clarification": true | false,
  "clarification_prompt": "—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ null"
}

üéØ –ü—Ä–∞–≤–∏–ª–∞:

1Ô∏è‚É£ **search_product**
   ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç —Ç–æ–≤–∞—Ä.
   –ü—Ä–∏–º–µ—Ä—ã: "–∞–π—Ñ–æ–Ω 15", "asus –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞", "ssd 1tb", "intel i5 10400f"
   ‚Üí intent = "search_product"
   ‚Äî –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π –≤ keywords:
     - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏ –±—Ä–µ–Ω–¥–∞;
     - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ("—Å–º–∞—Ä—Ç—Ñ–æ–Ω", "ssd", "–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä");
     - –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è (—Ç—Ä–∞–Ω—Å–ª–∏—Ç, –∞–Ω–≥–ª. –≤–µ—Ä—Å–∏—è);
     - keywords –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–º.
   ‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ("–Ω–æ—É—Ç–±—É–∫", "–≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞"), –¥–æ–±–∞–≤—å needs_clarification = true –∏ –≤–æ–ø—Ä–æ—Å –≤ clarification_prompt.

2Ô∏è‚É£ **build_pc**
   ‚Äî –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–æ–±—Ä–∞—Ç—å –ü–ö –∏–ª–∏ —Å–±–æ—Ä–∫—É.
   –ü—Ä–∏–º–µ—Ä—ã: "—Å–æ–±–µ—Ä–∏ –ø–∫ –Ω–∞ 500–∫", "–¥–∞–≤–∞–π —Å–±–æ—Ä–∫—É –∑–∞ 800 —Ç—ã—Å—è—á", "–∏–≥—Ä–æ–≤–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä –¥–æ –º–∏–ª–ª–∏–æ–Ω–∞"
   ‚Üí intent = "build_pc"
   ‚Äî –ò–∑–≤–ª–µ–∫–∏ —á–∏—Å–ª–æ–≤–æ–π –±—é–¥–∂–µ—Ç –≤ "budget" (–Ω–∞–ø—Ä–∏–º–µ—Ä 500000)
   ‚Äî –î—É–±–ª–∏—Ä—É–π –µ–≥–æ –≤ filters.max_price
   ‚Äî –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –¥–µ—Ç–∞–ª–∏ (–≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞, –ø–∞–º—è—Ç—å –∏ —Ç.–¥.) ‚Äî –∑–∞–ø–æ–ª–Ω–∏ –∏—Ö –≤ "components".
   ‚Äî –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –±—Ä–µ–Ω–¥—ã ("–Ω–∞ Ryzen", "–Ω–∞ Intel", "–Ω–∞ NVIDIA") ‚Äî –¥–æ–±–∞–≤—å –∏—Ö –≤ filters.brand.

3Ô∏è‚É£ **add_component**
   ‚Äî –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç/–∑–∞–º–µ–Ω—è–µ—Ç —á–∞—Å—Ç—å —Å–±–æ—Ä–∫–∏.
   –ü—Ä–∏–º–µ—Ä—ã: "–¥–æ–±–∞–≤—å ssd 1tb", "–∑–∞–º–µ–Ω–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–∫—É –Ω–∞ goodram 32", "–ø–æ—Å—Ç–∞–≤—å –¥—Ä—É–≥—É—é –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É"
   ‚Üí intent = "add_component"
   ‚Äî component_name = —Ç–µ–∫—Å—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ("goodram 32gb", "ssd 1tb").

4Ô∏è‚É£ **refine_selection**
   ‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
   –ü—Ä–∏–º–µ—Ä—ã: "–∞ –ø–æ–¥–µ—à–µ–≤–ª–µ?", "–∞ —á–µ—Ä–Ω—ã–π –µ—Å—Ç—å?", "–∞ –Ω–∞ –∏–Ω—Ç–µ–ª–µ?", "–∞ —Å 1 —Ç–µ—Ä–∞–±–∞–π—Ç–æ–º?"
   ‚Üí intent = "refine_selection"
   ‚Äî context_related = true
   ‚Äî normalized_query = null
   ‚Äî filters —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚Äú—á–µ—Ä–Ω—ã–π‚Äù ‚Üí —Ü–≤–µ—Ç, ‚Äú–ø–æ–¥–µ—à–µ–≤–ª–µ‚Äù ‚Üí max_price –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ).

5Ô∏è‚É£ **greeting**
   ‚Äî –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ —Ñ—Ä–∞–∑–∞ –±–µ–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è.
   –ü—Ä–∏–º–µ—Ä—ã: "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–∫–∞–∫ –¥–µ–ª–∞?"
   ‚Üí intent = "greeting"

6Ô∏è‚É£ **unknown**
   ‚Äî –ö–æ–≥–¥–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å.
   ‚Üí intent = "unknown"

7Ô∏è‚É£ **order_build**
‚Äî –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∑–∞–∫–∞–∑–∞—Ç—å —Å–±–æ—Ä–∫—É –∏–ª–∏ –∫—É–ø–∏—Ç—å –ü–ö.
–ü—Ä–∏–º–µ—Ä—ã:
- "—Ö–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–±–æ—Ä–∫—É", "–æ—Ñ–æ—Ä–º–∏ –∑–∞–∫–∞–∑", "–∫—É–ø–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä"
‚Üí intent = "order_build"


üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è:
- keywords –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–æ–≥–∞—Ç—ã–º–∏ –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è–º.
- –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π "language": "ru" | "kk" | "en".
- confidence = 1.0, –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –Ω–µ –∑–∞–∫–ª—é—á–∞–π JSON –≤ \`\`\`.
          `,
        },
        { role: "user", content: question },
      ],
      temperature: 0.3,
      max_tokens: 700,
    })

    const content = completion.choices[0].message.content || "{}"
    const clean = content.replace(/```json|```/g, "").trim()

    let parsed
    try {
      parsed = JSON.parse(clean)
    } catch (err) {
      console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON, –æ—Ç–≤–µ—Ç GPT:", clean)
      parsed = {
        intent: "unknown",
        original_query: question,
        normalized_query: null,
        filters: {},
        components: {},
        context_related: false,
        language: "ru",
        confidence: 0,
        needs_clarification: false,
        clarification_prompt: null,
      }
    }

    console.log("‚úÖ [INTENT PARSED]:", parsed)
    return NextResponse.json(parsed)
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ INTENT API:", error)
    return NextResponse.json(
      {
        intent: "unknown",
        original_query: null,
        normalized_query: null,
        filters: {},
        components: {},
        context_related: false,
        language: "ru",
        confidence: 0,
        needs_clarification: false,
        clarification_prompt: null,
      },
      { status: 200 }
    )
  }
}
